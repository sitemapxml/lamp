#!/bin/bash

# Definicije boja
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'

# Reset boja - No Color
NC='\033[0m' 

# Unos neophodnih podataka
echo -e ${YELLOW}'Molimo vas da unesete osnovne podatke o infra-strukturi: '${NC}

while true; do
    read -p 'Unesite naziv domena bez protokola (bez http://): ' hostname
    read -p 'Unesite ponovo da bi ste potvrdili: ' hostname2
    [ "$hostname" = "$hostname2" ] && break
    echo -e ${RED}'Molimo pokušajte ponovo.'${NC}
done

echo
read -p 'Unesite korisničko ime UNIX korisnika: ' unixuser

while true; do
    read -s -p 'Unesite lozinku UNIX korisnika: ' unixpass
	echo
    read -s -p 'Unesite ponovo da bi ste potvrdili: ' unixpass2
	echo
    [ "$unixpass" = "$unixpass2" ] && break
    echo -e ${RED}'Molimo pokušajte ponovo.'${NC}
	echo
done

echo
echo $'\033[1;33mPodešavanje lozinke za MYSQL root korinkika\033[0m'
while true; do
    read -s -p 'Unesite lozinku za MYSQL root: ' mysqlrpass
	echo
    read -s -p 'Unesite ponovo da bi ste potvrdili: ' mysqlrpass2
	echo
    [ "$mysqlrpass" = "$mysqlrpass2" ] && break
    echo -e ${RED}'Molimo pokušajte ponovo.'${NC}
	echo
done

echo
echo -e ${YELLOW}'Podešavanje Email adrese administratora'${NC}
while true; do
    read -p 'Unesite vašu Email adresu: ' email
    read -p 'Unesite ponovo da bi ste potvrdili: ' email2
    [ "$email" = "$email2" ] && break
    echo -e ${RED}'Molimo pokušajte ponovo.'${NC}
	echo
done

# Početak instalacije
echo -e ${YELLOW}'Neophodne informacije su prikupljene. Instalacija može da počne.'${NC}
read -p $'\033[1;33mPritisnite [Enter] da bi ste nastavili...\033[0m'
echo 'Krećemo...'
sleep 1s

echo -e ${YELLOW}'Ažuriranje liste repozitorija...'${NC}
sleep 1s
apt update

echo -e ${YELLOW}'Dodavanje repozitorija...'${NC}
add-apt-repository main
add-apt-repository universe
apt update

apt install software-properties-common apt-transport-https -y

echo -e ${YELLOW}'Instalira se apache2, php i mysql'${NC}
apt install apache2 php mysql-server -y

echo -e ${YELLOW}'Instaliranje php ekstenzija...'${NC}
apt install php-zip php-mysql php-curl php-mbstring php-bcmath php-gd php-xml php-json php-soap php-intl -y 

systemctl enable mysql apache2

apt install zip unzip tree -y

# Osnovna podešavanja php-a, ServerTokens
echo -e ${YELLOW}'Konfigurisanje php-a...'${NC}
sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g' /etc/php/7.2/apache2/php.ini
sed -i 's/post_max_size = 8M/post_max_size = 280M/g' /etc/php/7.2/apache2/php.ini
sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 256M/g' /etc/php/7.2/apache2/php.ini
sed -i 's/ServerTokens OS/ServerTokens Prod/g' /etc/apache2/conf-available/security.conf
systemctl restart apache2

# Webmin instalacija
echo -e ${YELLOW}'Instaliranje Webmin kontrolne table...'${NC}
echo "deb http://download.webmin.com/download/repository sarge contrib" >> /etc/apt/sources.list
apt-key add jcameron-key.asc
apt update
apt --yes install webmin
sed -i 's/port=10000/port=3000/g' /etc/webmin/miniserv.conf
/etc/init.d/webmin restart

# Podešavanje veb servera
rm -rf /var/www/html
mkdir /var/www/$hostname
cp vhost.conf /etc/apache2/sites-available/$hostname.conf
sed -i "s/sn_default/$hostname/g" /etc/apache2/sites-available/$hostname.conf
sed -i "s/dir_default/$hostname/g" /etc/apache2/sites-available/$hostname.conf
a2dissite 000-default
a2ensite $hostname
systemctl restart apache2

# 6g zaštitni zid
while true; do
    read -p 'Da li želite da omogućite 6g zaštitni zid? (Da/Ne): ' dn
    case $dn in
        [Dd]* )
		cp 6g.conf /etc/apache2/6g.conf
		sed -i "s/#6g //g" /etc/apache2/sites-available/$hostname.conf
		systemctl restart apache2
echo "Zaštitni zid je omogućen!"
break;;
        [Nn]* ) exit;;
        * ) echo -e ${RED}Molimo vas da odgovorite sa Da ili Ne.${NC};;
    esac
done

# Instalacija Wordpress-a
while true; do
    read -p 'Da li želite da instalirate Wordpress? (Da/Ne): ' dn
    case $dn in
        [Dd]* )

		# Instaliranje faljova
		wget https://sr.wordpress.org/latest-sr_RS.tar.gz
		tar -xzvf latest-sr_RS.tar.gz
		mv wordpress /var/www/$hostname/html
		chown www-data:www-data -R /var/www/$hostname/html

		# Instaliranje dodatnih php ekstenzija
		apt install php-xmlrpc php-exif -y
		systemctl restart apache2

		# Brisanje nepotrebnih fajlova
		rm latest-sr_RS.tar.gz

echo 'Wordpress je instaliran!'
break;;
        [Nn]* )
		
		# Iskopiraj index.html u webroot
		mkdir /var/www/$hostname/html
		cp index.html /var/www/$hostname/html/index.html
		echo "<?php phpinfo(); ?>" > /var/www/$hostname/html/info.php
		
echo 'Podešen je index.html i phpinfo fajl.'
exit;;
        * ) echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC};;
    esac
done

# Instalacija SSL sertifikata
while true; do
    read -p 'Da li želite da instalirate SSL sertifikat? (Da/Ne): ' dn
    case $dn in
        [Dd]* )

		# Certbot instalacija
		add-apt-repository ppa:certbot/certbot -y
		apt update
		apt install python-certbot-apache -y

		# Instalacija Let's encrypt SSL sertifikata
		certbot --apache --non-interactive --agree-tos --domains $hostname --email $email

echo 'SSL je instaliran!'
break;;
        [Nn]* ) exit;;
        * ) echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC};;
    esac
done

# Kreiranje fajla sa lozinkama
while true; do
    read -p 'Da li želite da napravite rezervnu kopiju korisničkih imena i lozinki? (Da/Ne): ' dn
    case $dn in
        [Dd]* )
		while true; do
			echo -e ${RED}'Ova opcija nije bezbedna. Savetujemo vam da fajl iskopirate na sigurno mesto i da ga u što kraćem roku obrišete sa servera.'${NC}
			read -p 'Da li ste sigurni da želite da nastavite? (Da/Ne): ' dn
			case $dn in
				[Dd]* )
				echo 'Kopiranje lozinki...'
				echo -e 'UNIX User:' $unixuser'\n''UNIX Password:' $unixpass'\n''Hostname:' $hostname > podaci.txt
		echo 'Lozinke su iskopirane.'
		break;;
				[Nn]* )
		echo 'Lozinke nisu iskopirane.'
		exit;;
				* ) echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC};;
			esac
		done
break;;
        [Nn]* )
exit;;
        * ) echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC};;
    esac
done

echo -e ${GREEN}'Instalacija je završena!'${NC}