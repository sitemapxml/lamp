#!/bin/bash

#############################################
# https://github.com/sitemapxml/lamp        #
# Autor: https://github.com/sitemapxml      #
# Licenca: MIT                              #
# Datum prvog objavljivanja: Dec 25, 2019.  #
# Verzija: 0.9.3-BETA                       #
#############################################

# Definicije boja
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'

# Reset boja - No Color
NC='\033[0m'

# Davanje privilegija za pokretanje ostalim skriptama
chmod +x mksite
chmod +x uninstall

# Poruka dobrodošlice!
text=''
text+="${GREEN}*************************************************\n"
text+="Dobro došli u LAMP skriptu za instalaciju!\n"
text+="Sledeći programi će biti instalirani:\n"
text+="   - apache2 veb server\n"
text+="   - mysql 5.6\n"
text+="   - php 7.2\n"
text+="PHP ekstenzije:\n"
text+="   php-zip php-mysql php-mbstring php-curl\n"
text+="   php-gd php-xml php-xmlrpc php-soap php-intl\n"
text+="Kontrolna tabla:\n"
text+="   Webmin - poslednja verzija\n"
text+="Sitni pomoćni programi:\n"
text+="   zip unzip tree\n"
text+="Dodatna podešavanja php-a:\n"
text+="   cgi.fix_pathinfo=0\n"
text+="   post_max_size = 280M\n"
text+="   upload_max_filesize = 256M\n"
text+="NAPOMENE:\n"
text+="   Biće napravljen virtualhost fajl sa osnovnim\n"
text+="podešavanjima domena. U toku instalacije imaćete\n"
text+="mogućnost da odaberete instalaciju Wordpress-a\n"
text+="u suprotnom biće kreiran probni index.html\n"
text+="i info.php fajl za proveru ispravnosti instalacije.\n"
text+="***************************************************\n${NC}"
printf "%b" "$text"

# Unos neophodnih podataka
echo -e ${YELLOW}'Molimo vas da unesete osnovne podatke o infra-strukturi: '${NC}
echo

echo -e ${YELLOW}'Korak (1/6)'${NC}
while true; do
    read -p 'Unesite naziv domena bez protokola (bez http://): ' hostname
    read -p 'Unesite ponovo da bi ste potvrdili: ' hostname2
    [ "$hostname" = "$hostname2" ] && break
    echo -e ${RED}'Molimo pokušajte ponovo.'${NC}
done

echo -e ${YELLOW}'Korak (2/6)'${NC}
while true; do
    read -s -p 'Unesite lozinku root korisnika: ' rootpass
	echo
    read -s -p 'Unesite ponovo da bi ste potvrdili: ' rootpass2
	echo
    [ "$rootpass" = "$rootpass2" ] && break
    echo -e ${RED}'Molimo pokušajte ponovo.'${NC}
	echo
done

echo
echo -e ${YELLOW}'Korak (3/6)'${NC}
read -p 'Unesite korisničko ime UNIX korisnika: ' unixuser

echo -e ${YELLOW}'Korak (4/6)'${NC}
while true; do
    read -s -p 'Unesite lozinku UNIX korisnika: ' unixpass
	echo
    read -s -p 'Unesite ponovo da bi ste potvrdili: ' unixpass2
	echo
    [ "$unixpass" = "$unixpass2" ] && break
    echo -e ${RED}'Molimo pokušajte ponovo.'${NC}
	echo
done

echo
echo -e ${YELLOW}'Korak (5/6)'${NC}
echo -e ${YELLOW}'Podešavanje lozinke za MYSQL root korisnika'${NC}
while true; do
    read -s -p 'Unesite lozinku za MYSQL root: ' mysqlrpass
	echo
    read -s -p 'Unesite ponovo da bi ste potvrdili: ' mysqlrpass2
	echo
    [ "$mysqlrpass" = "$mysqlrpass2" ] && break
    echo -e ${RED}'Molimo pokušajte ponovo.'${NC}
	echo
done

echo
echo -e ${YELLOW}'Korak (6/6)'${NC}
echo -e ${YELLOW}'Podešavanje Email adrese administratora'${NC}
while true; do
    read -p 'Unesite vašu Email adresu: ' email
    read -p 'Unesite ponovo da bi ste potvrdili: ' email2
    [ "$email" = "$email2" ] && break
    echo -e ${RED}'Molimo pokušajte ponovo.'${NC}
	echo
done

# Početak instalacije
echo
echo -e ${YELLOW}'Neophodne informacije su prikupljene. Instalacija može da počne.'${NC}
read -p $'\033[1;33mPritisnite [Enter] da bi ste nastavili...\033[0m'
echo 'Krećemo...'
sleep 1s

# Ažuriranje liste repozitorija, nadogradnja se preporučuje na kraju
echo -e ${YELLOW}'Ažuriranje liste repozitorija...'${NC}
sleep 1s
apt-get update

# Dodavanje main repozitorije za slučaj da nije dodata, dodavanje universe repozitorije
echo -e ${YELLOW}'Dodavanje repozitorija...'${NC}
add-apt-repository main
add-apt-repository universe
apt-get update

# Instalacija software-properties-common za slučaj da nije instalirano
apt-get install software-properties-common apt-transport-https -y

# Instalacija php i mysql, php ekstenzije, sitni pomoćni programi zip, unzip i tree
echo -e ${YELLOW}'Instalira se apache2, php i mysql'${NC}
sleep 1s
apt-get install apache2 php mysql-server -y
echo -e ${YELLOW}'Instaliranje php ekstenzija...'${NC}
sleep 1s
apt-get install php-zip php-mysql php-curl php-mbstring php-bcmath php-gd php-xml php-json php-soap php-intl -y 
systemctl enable mysql apache2
apt-get install zip unzip tree -y

# Osnovna podešavanja php-a, ServerTokens
echo -e ${YELLOW}'Konfigurisanje php-a...'${NC}
sleep 1s
sed -i 's/;cgi.fix_pathinfo=1/cgi.fix_pathinfo=0/g' /etc/php/7.2/apache2/php.ini
sed -i 's/post_max_size = 8M/post_max_size = 280M/g' /etc/php/7.2/apache2/php.ini
sed -i 's/upload_max_filesize = 2M/upload_max_filesize = 256M/g' /etc/php/7.2/apache2/php.ini
sed -i 's/ServerTokens OS/ServerTokens Prod/g' /etc/apache2/conf-available/security.conf
systemctl restart apache2

# Webmin instalacija
echo -e ${YELLOW}'Instaliranje Webmin kontrolne table...'${NC}
sleep 1s
echo "deb http://download.webmin.com/download/repository sarge contrib" >> /etc/apt/sources.list
apt-key add files/jcameron-key.asc
apt-get update
apt-get --yes install webmin
sed -i 's/port=10000/port=3000/g' /etc/webmin/miniserv.conf
/etc/init.d/webmin restart

# Podešavanje veb servera
echo -e ${YELLOW}'Konfigurisanje Apache servera...'${NC}
sleep 1s
rm -rf /var/www/html
mkdir /var/www/$hostname
cp files/vhost.conf /etc/apache2/sites-available/$hostname.conf
sed -i "s/sn_default/$hostname/g" /etc/apache2/sites-available/$hostname.conf
sed -i "s/dir_default/$hostname/g" /etc/apache2/sites-available/$hostname.conf
a2dissite 000-default
rm 000-default.conf
a2ensite $hostname
a2enmod rewrite
systemctl restart apache2

# Dodavanje UNIX korisnika
echo -e ${YELLOW}'Dodavanje UNIX korisnika...'${NC}
sleep 1s
adduser $unixuser --gecos "First Last,RoomNumber,WorkPhone,HomePhone" --disabled-password
echo -e "$unixuser:$unixpass" | chpasswd
echo "$unixuser ALL=(ALL:ALL) ALL" | EDITOR='tee -a' visudo
echo -e ${GREEN}"Korisnik $unixuser je kreiran."${NC}

# Postavljanje nove root lozinke
echo -e ${YELLOW}'Postavljanje nove lozinke za root...'${NC}
sleep 1s
echo -e "root:$rootpass" | chpasswd
echo -e ${GREEN}'Lozinka je ažurirana!'${NC}

# Podešavanje hostname-a prema unetom domenu
hostnamectl set-hostname $hostname

# Kreiranje direktorijuma za skladištenje lozinki
mkdir .podaci
chmod 0000 -R .podaci

# Instalacija Wordpress-a
while true
	do
	echo -e ${YELLOW}'Korak (1/5)'${NC}
	read -p 'Da li želite da instalirate Wordpress? (Da/Ne): ' wp_install
		case $wp_install in
		[dD][aA]|[dD])
			# Instaliranje faljova
			wget https://sr.wordpress.org/latest-sr_RS.tar.gz
			tar -xzvf latest-sr_RS.tar.gz
			mv wordpress /var/www/$hostname/html
			chown www-data:www-data -R /var/www/$hostname/html
			echo -e '\n/* FS Method */\ndefine('FS_METHOD','direct');' >> /var/www/$hostname/html/wp-config-sample.php

			# Instaliranje dodatnih php ekstenzija
			apt-get install php-xmlrpc php-exif -y
			systemctl restart apache2

			# Brisanje nepotrebnih fajlova
			rm latest-sr_RS.tar.gz

			# Kreiranje baze podataka
			database_password=`date +%s | sha256sum | base64 | head -c 32`
			mysql -u root -p -e "create database $hostname DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci; GRANT ALL PRIVILEGES ON $hostname.* TO $unixuser@localhost IDENTIFIED BY '$database_password'; flush privileges;"
			echo '==================================================================' > database-info.txt
			echo '============= Pristupni parametri za bazu podataka ===============' >> database-info.txt
			echo '==================================================================' >> database-info.txt
			echo -e '\n''Naziv baze podataka:' $hostname'\nKorisničko ime:' $unixuser'\nLozinka:' $database_password'\n' >> database-info.txt

			# Konfigurisanje Wordpress Multisite instalacije
				while true
					do
					read -p 'Da li želite da omogućite Wordpress Multisite? (Da/Ne): ' wp_install_multisite
						case $wp_install_multisite in
						[dD][aA]|[dD])
							# Instaliranje faljova
							echo 'Konfiguriše se Multisite...'
							echo -e '\n/* Multisite */\ndefine( 'WP_ALLOW_MULTISITE', true );' >> /var/www/$hostname/html/wp-config-sample.php
							echo -e ${GREEN}'Multisite je podešen!'${NC}
						break
						;;
					[nN][eE]|[nN])
						break
						;;
						*)
							echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC}
						;;
					esac
				done
			echo -e ${GREEN}'Wordpress je instaliran!'${NC}
		break
		;;
		[nN][eE]|[nN])
			# Iskopiraj index.html u webroot
			mkdir /var/www/$hostname/html
			cp files/index.html /var/www/$hostname/html/index.html
			echo "<?php phpinfo(); ?>" > /var/www/$hostname/html/info.php
			echo 'Podešeni su index.html i phpinfo fajl.'
		break
		;;
	*)
		echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC}
	;;
	esac
done

# Instalacija SSL sertifikata
while true
	do
	echo -e ${YELLOW}'Korak (2/5)'${NC}
	read -p 'Da li želite da instalirate SSL sertifikat? (Da/Ne): ' ssl_install
		case $ssl_install in
		[dD][aA]|[dD])
			echo 'Instalira se SSL...'
			sleep 1s
			# Certbot instalacija
			add-apt-repository ppa:certbot/certbot -y
			apt-get update
			apt-get install python-certbot-apache -y

			# Instalacija Let's encrypt SSL sertifikata
			certbot --apache --non-interactive --agree-tos --domains $hostname --email $email
			
			# Podesavanje SSL-a za Webmin
			echo -e ${YELLOW}'Podesavanje SSL-a za Webmin...'${NC}
			sed -i '/keyfile/d' /etc/webmin/miniserv.conf
			echo -e 'keyfile=''/''etc''/''letsencrypt''/''live''/'"$hostname"'/''privkey.pem' >> /etc/webmin/miniserv.conf
			echo -e 'certfile=''/''etc''/''letsencrypt''/''live''/'"$hostname"'/''fullchain.pem' >> /etc/webmin/miniserv.conf
			/etc/init.d/webmin restart

			# Putanje do instaliranih SSL sertifikata
			echo -e '\nPodaci o SSL sertifikatima:' >> ssl-info.txt
			certbot certificates >> ssl-info.txt
			chmod 0400 ssl-info.txt
			echo -e ${GREEN}'SSL je instaliran!'${NC}
		break
		;;
		[nN][eE]|[nN])
			echo 'Preskače se...'
	break
	;;
	*)
		echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC}
	;;
	esac
done

# 6g zaštitni zid
while true
	do
	echo -e ${YELLOW}'Korak (3/5)'${NC}
	read -p 'Da li želite da omogućite Apache 6G zaštitni zid? (Da/Ne): ' apache_firewall
		case $apache_firewall in
		[dD][aA]|[dD])
			cp files/6g.conf /etc/apache2/6g.conf
			sed -i "s/#6g //g" /etc/apache2/sites-available/$hostname.conf
			systemctl restart apache2
			echo -e ${GREEN}'Zaštitni zid je omogućen!'${NC}
		break
		;;
		[nN][eE]|[nN])
			echo 'Preskače se...'
	break
	;;
	*)
		echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC}
	;;
	esac
done

# UFW zaštitni zid
while true
	do
	echo -e ${YELLOW}'Korak (4/5)'${NC}
	read -p 'Da li želite da omogućite zaštitu portova? (Da/Ne): ' ufw_firewall
		case $ufw_firewall in
		[dD][aA]|[dD])
			ufw --force enable
			ufw allow 'OpenSSH'
			ufw allow 'Apache Full'
			ufw allow '3000/tcp'
			ufw reload
			echo -e ${GREEN}'Zaštita portova je omogućena!'${NC}
		break
		;;
		[nN][eE]|[nN])
			echo 'Preskače se...'
	break
	;;
	*)
		echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC}
	;;
	esac
done

# Kreiranje fajla sa lozinkama
while true
	do
	echo -e ${YELLOW}'Korak (5/5)'${NC}
	read -r -p 'Da li želite da napravite rezervnu kopiju korisničkih imena i lozinki? (Da/Ne): ' backup_file
		case $backup_file in
		[dD][aA]|[dD])
		while true
			do
			echo -e ${RED}'Ova opcija nije bezbedna. Savetujemo vam da fajl iskopirate na sigurno mesto i da ga u što kraćem roku obrišete sa servera.'${NC}
			read -p 'Da li ste sigurni da želite da nastavite? (Da/Ne): ' backup_file_confirm
				case $backup_file_confirm in
				[dD][aA]|[dD])
					echo 'Kopiranje lozinki...'
					sleep 1s
					echo -e 'Hostname:' $hostname'\nUNIX User:' $unixuser'\nUNIX Password:' $unixpass'\n' > podaci.txt
					echo -e 'E-mail:' $email'\nRoot lozinka za mysql:' $mysqlrpass'\n\n' >> podaci.txt
					echo '*************************************************************************************' >> podaci.txt
					echo 'VAŽNA NAPOMENA:' >> podaci.txt
					echo 'U OVOM FAJLU SE NALAZE INFORMACIJE KOJE KOGU UGROZITI BEZBEDNOST SERVERA I SVIH' >> podaci.txt
					echo 'APLIKACIJA NA NJEMU. PREPORUČUJE SE DA LOZINKE SAČUVATE NA SIGURNOM MESTU I DA OVAJ' >> podaci.txt
					echo 'FAJL OBRIŠETE ŠTO PRE. PREPORUČUJE SE KORIŠĆENJE "PASSWORD MANAGER-A".' >> podaci.txt
					echo '*************************************************************************************' >> podaci.txt
					chmod 0000 podaci.txt
					echo -e ${GREEN}'Lozinke su iskopirane.'${NC}
				break
				;;
				[nN][eE]|[nN])
					echo 'Preskače se...'
				break
				;;
			*)
				echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC}
			;;
			esac
		done
		break
		;;
		[nN][eE]|[nN])
			echo 'Preskače se...'
		break
		;;
	*)
		echo -e ${RED}'Molimo vas da odgovorite sa Da ili Ne.'${NC}
	;;
	esac
done

echo -e ${GREEN}'Instalacija je završena!'${NC}

# Brisanje bash istorije
cat /dev/null > ~/.bash_history && history -c